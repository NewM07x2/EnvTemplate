<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Django 開発ガイド（DEV_GUIDE）</title>
    <style>
      /* Light theme: background light gray, cards white, dark text */
      :root {
        --bg: #f3f4f6; /* light gray page background */
        --card: #ffffff; /* white cards */
        --muted: #475569; /* muted dark slate */
        --text: #0f1724; /* primary text */
        --accent: #6c5ce7; /* purple accent */
        --glass: rgba(15, 23, 36, 0.04);
        --code-bg-dark: #0b1220;
        --code-bg-light: #f1f5f9;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI',
          Roboto, Helvetica, Arial;
        color: var(--text);
        background: linear-gradient(180deg, var(--bg) 0%, #eef2f6 100%);
      }
      .wrap {
        max-width: 1200px;
        margin: 28px auto;
        padding: 20px;
      }
      .layout {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 20px;
      }
      .card {
        background: var(--card);
        border-radius: 12px;
        padding: 18px;
        box-shadow: 0 8px 24px rgba(15, 23, 36, 0.08);
        border: 1px solid rgba(15, 23, 36, 0.06);
      }
      header .title {
        margin: 0;
        font-size: 20px;
        font-weight: 700;
        color: var(--text);
      }
      .subtitle {
        color: var(--muted);
        font-size: 13px;
        margin-top: 6px;
      }
      /* Sidebar */
      nav.toc {
        position: sticky;
        top: 20px;
        height: calc(100vh - 56px);
        overflow: auto;
        padding: 14px;
      }
      nav.toc h3 {
        margin: 0 0 12px 0;
        color: var(--text);
      }
      nav.toc ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      nav.toc li {
        margin: 8px 0;
      }
      nav.toc a {
        color: var(--muted);
        text-decoration: none;
        padding: 8px 10px;
        border-radius: 8px;
        display: block;
        transition: all 150ms ease;
      }
      nav.toc a:hover {
        background: var(--glass);
        color: var(--text);
        transform: translateX(4px);
      }
      /* Content */
      article {
        padding: 18px;
      }
      h2 {
        color: var(--text);
        border-left: 4px solid var(--accent);
        padding-left: 12px;
        font-size: 18px;
        margin-top: 8px;
      }
      h3 {
        color: var(--text);
      }
      p,
      li {
        color: var(--muted);
        font-size: 14px;
      }
      code {
        background: var(--code-bg-light);
        padding: 3px 6px;
        border-radius: 6px;
        color: var(--text);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Roboto Mono,
          monospace;
      }
      pre {
        background: linear-gradient(180deg, var(--code-bg-dark), #061022);
        padding: 14px;
        border-radius: 10px;
        color: #e6eef8;
        overflow: auto;
        border: 1px solid rgba(255, 255, 255, 0.02);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Roboto Mono,
          monospace;
      }
      ol,
      ul {
        margin: 10px 0 18px 0;
      }
      .cmd {
        display: inline-block;
        background: linear-gradient(90deg, #f8fafc, #eef2f7);
        color: var(--text);
        padding: 8px 10px;
        border-radius: 8px;
        font-family: ui-monospace, monospace;
      }
      .note {
        background: #fff7cc;
        color: #6b4b00;
        padding: 10px;
        border-radius: 8px;
      }
      .footer {
        color: var(--muted);
        font-size: 13px;
        margin-top: 18px;
      }
      /* Responsive */
      @media (max-width: 880px) {
        .layout {
          grid-template-columns: 1fr;
        }
        .wrap {
          padding: 12px;
        }
        .card {
          padding: 12px;
        }
        nav.toc {
          position: static;
          height: auto;
          margin-bottom: 12px;
        }
      }
      /* Smooth anchor scrolling */
      html {
        scroll-behavior: smooth;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="layout">
        <nav class="card toc" aria-label="目次">
          <div>
            <h3>目次</h3>
            <ul>
              <li><a href="#intro">はじめに</a></li>
              <li><a href="#structure">プロジェクト構成の把握</a></li>
              <li><a href="#workflow">開発時の基本作業フロー</a></li>
              <li><a href="#follow-code">コードの追い方（実践）</a></li>
              <li><a href="#request-flow">よくある処理の流れ</a></li>
              <li><a href="#migrations">マイグレーションとデータベース</a></li>
              <li><a href="#docker">Docker を使った開発</a></li>
              <li><a href="#celery">Celery / バックグラウンドワーカー</a></li>
              <li><a href="#tests">テストの書き方と実行</a></li>
              <li><a href="#debug">デバッグの基本テクニック</a></li>
              <li>
                <a href="#troubleshoot">トラブルシューティングのヒント</a>
              </li>
              <li><a href="#refs">参考資料</a></li>
            </ul>
          </div>
          <div style="margin-top: 14px; font-size: 13px; color: var(--muted)">
            Tips: ブラウザの検索 (Ctrl+F) で素早くセクションを探せます
          </div>
        </nav>

        <main class="card">
          <header class="header">
            <div>
              <h1 class="title">Django 開発ガイド（初学者向け）</h1>
              <div class="subtitle">
                テンプレートプロジェクト: python/Django — REST + GraphQL /
                Docker / Celery
              </div>
            </div>
          </header>

          <article>
            <h2 id="intro">はじめに</h2>
            <p>
              このテンプレートは、Django 5.0 を用いた REST API + GraphQL
              のハイブリッド構成を採用しています。コードはレイヤードアーキテクチャ（models
              → repositories → services → serializers →
              views）に分かれており、各層の役割を分離して理解することが大切です。
            </p>

            <h2 id="structure">プロジェクト構成の把握</h2>
            <p>主なトップレベルディレクトリ:</p>
            <ul>
              <li>
                <code>apps/</code> - 各ドメインアプリ（<code>users</code>,
                <code>posts</code> など）。ここがビジネスロジックの本体です。
              </li>
              <li>
                <code>config/</code> -
                プロジェクト設定（<code>settings.py</code>,
                <code>urls.py</code>, <code>wsgi.py</code>,
                <code>asgi.py</code>, <code>celery.py</code>）
              </li>
              <li><code>core/</code> - 共通のユーティリティやヘルスチェック</li>
              <li><code>docker/</code> - Dockerfile 等</li>
              <li><code>tests/</code> - pytest 用テスト</li>
            </ul>
            <p>各アプリの典型的な構成（例: <code>apps/users</code>）:</p>
            <ul>
              <li><code>models.py</code> - Django モデル定義</li>
              <li><code>repositories.py</code> - DB 操作をまとめた層</li>
              <li><code>services.py</code> - ビジネスロジック</li>
              <li><code>serializers.py</code> - DRF シリアライザー</li>
              <li><code>views.py</code> - ViewSet / API のエンドポイント</li>
              <li><code>schema.py</code> - GraphQL スキーマ</li>
            </ul>

            <h2 id="workflow">開発時の基本作業フロー</h2>
            <ol>
              <li>ブランチを作成する</li>
              <li>依存関係をインストール（ローカル）</li>
              <li>マイグレーションを作る/適用</li>
              <li>サーバーを起動して動作確認</li>
              <li>テストを実行</li>
              <li>PR を作成</li>
            </ol>

            <h2 id="follow-code">コードの追い方（実践）</h2>
            <p>
              以下は API リクエストが来てから DB
              に保存されるまでを追う具体的な方法です。
            </p>
            <ol>
              <li>
                ルーティングを探す
                <ul>
                  <li>
                    <code>config/urls.py</code> と各アプリの
                    <code>urls.py</code> を確認してエンドポイント（例:
                    <code>/api/users/</code>）の割当を探す。
                  </li>
                </ul>
              </li>
              <li>
                view を開く
                <ul>
                  <li>
                    <code>apps/&lt;app&gt;/views.py</code> の ViewSet または
                    APIView を特定。どの serializer、service
                    を使っているかを見る。
                  </li>
                </ul>
              </li>
              <li>
                serializer を確認
                <ul>
                  <li>
                    <code>serializers.py</code>
                    で入力バリデーション、create/update
                    の処理が書かれているか確認。
                  </li>
                </ul>
              </li>
              <li>
                service/repository を追う
                <ul>
                  <li>
                    ビジネスロジックは <code>services.py</code> にあり、DB
                    操作は
                    <code>repositories.py</code> に集約されていることが多い。
                  </li>
                </ul>
              </li>
              <li>
                model を確認
                <ul>
                  <li>
                    <code>models.py</code> を見て DB
                    のカラムやリレーションを把握する。
                  </li>
                </ul>
              </li>
              <li>
                実行時のログを参照
                <ul>
                  <li>
                    サーバーの標準出力や
                    <code>docker-compose logs</code> を見て、SQL
                    や例外のスタックトレースを追う。
                  </li>
                </ul>
              </li>
            </ol>
            <p><strong>Tips:</strong></p>
            <ul>
              <li>
                まずユニットテストを読むとその機能の期待仕様がわかりやすい。
              </li>
              <li>
                <code>grep</code> / VSCode
                の「参照」機能で関数名やクラス名を横断検索する。
              </li>
            </ul>

            <h2 id="request-flow">
              よくある処理の流れ（例: ユーザー作成 API）
            </h2>
            <ol>
              <li><code>POST /api/users/</code> が来る</li>
              <li>
                <code>apps/users/views.py</code> の
                <code>UserViewSet.create</code>（または generic ViewSet の
                <code>create</code>）が呼ばれる
              </li>
              <li><code>serializers.UserSerializer</code> でデータ検証</li>
              <li>
                <code>services.UserService.create_user(...)</code>
                が呼ばれ、必要であれば
                <code>repositories.UserRepository</code> が DB に保存
              </li>
              <li>レスポンスを返す</li>
            </ol>

            <h2 id="migrations">マイグレーションとデータベース</h2>
            <ul>
              <li>
                マイグレーションファイルは
                <code>apps/&lt;app&gt;/migrations/</code> にあります。
              </li>
              <li>
                開発では <code>python manage.py makemigrations</code> と
                <code>python manage.py migrate</code> を使います。
              </li>
              <li>
                Docker 環境では
                <code>docker-compose exec app python manage.py migrate</code>
                を実行します。
              </li>
              <li>
                問題があれば、<code>docker-compose down -v</code>
                でボリュームを消してクリーンに再構築できます（データは失われます）。
              </li>
            </ul>

            <h2 id="docker">Docker を使った開発</h2>
            <ul>
              <li><code>docker-compose up -d --build</code> で起動。</li>
              <li><code>docker-compose logs -f app</code> でログを追う。</li>
              <li>
                依存サービス（Postgres, Redis）は
                <code>docker-compose.yml</code> で定義されています。
              </li>
              <li>
                entrypoint
                がマイグレーションを行う設定になっている場合、環境変数
                <code>AUTO_MIGRATE=false</code> で無効化できます。
              </li>
            </ul>

            <h2 id="celery">Celery / バックグラウンドワーカー</h2>
            <ul>
              <li>
                Celery は <code>config/celery.py</code> で定義されています。
              </li>
              <li>
                ワーカー起動:
                <code>celery -A config worker -l info</code>（Docker:
                <code
                  >docker-compose exec celery_worker celery -A config worker -l
                  info</code
                >）
              </li>
              <li>
                ビート起動:
                <code>celery -A config beat -l info</code>（スケジューラ）
              </li>
              <li>
                Celery
                が起動しない場合は、<code>config.celery</code>（ファイル）と
                <code>CELERY_BROKER_URL</code>（redis）を確認。
              </li>
            </ul>

            <h2 id="tests">テストの書き方と実行</h2>
            <ul>
              <li>pytest を使用しています。</li>
              <li>すべてのテストを実行する: <code>pytest</code></li>
              <li>
                Docker 内で実行: <code>docker-compose exec app pytest</code>
              </li>
              <li>
                テスト時は DB の状態を fixture で制御する（<code
                  >tests/conftest.py</code
                >
                を参照）。
              </li>
            </ul>

            <h2 id="debug">デバッグの基本テクニック</h2>
            <ol>
              <li>
                ログを読む
                <ul>
                  <li>
                    Django のエラースタックトレースは詳細を示します。<code
                      >docker-compose logs -f app</code
                    >
                    で確認。
                  </li>
                </ul>
              </li>
              <li>
                ローカルで落ちる箇所を再現
                <ul>
                  <li>
                    該当のリクエストを curl/Postman
                    で作成し、エラーメッセージとスタックトレースを取得する。
                  </li>
                </ul>
              </li>
              <li>
                print / logging を一時的に入れる
                <ul>
                  <li>
                    小さいプロジェクトでは <code>print()</code> で確認することも
                    OK。ただし本番では <code>logging</code> を使う。
                  </li>
                </ul>
              </li>
              <li>
                Django shell を使う
                <ul>
                  <li>
                    <code>docker-compose exec app python manage.py shell</code>
                    でモデルやサービスの動作を対話的に確認。
                  </li>
                </ul>
              </li>
              <li>
                breakpoints (VSCode と debugpy)
                <ul>
                  <li>
                    <code>pip install debugpy</code> して、<code
                      >python -m debugpy --listen 0.0.0.0:5678 --wait-for-client
                      manage.py runserver</code
                    >
                    のように起動してデバッガからアタッチ。
                  </li>
                </ul>
              </li>
            </ol>

            <h2 id="troubleshoot">トラブルシューティングのヒント</h2>
            <ul>
              <li>
                マイグレーションの競合: 複数コンテナが同時に migrate
                を実行している場合は、<code>AUTO_MIGRATE=false</code>
                にして一つのジョブで migrate を行う。
              </li>
              <li>
                Celery が起動しない:
                <code>config.celery</code>
                の存在、<code>CELERY_BROKER_URL</code>（redis）を確認。ログの
                <code>Module 'config' has no attribute 'celery'</code> は
                <code>config/__init__.py</code> に
                <code>from .celery import app as celery_app</code>
                を追加すれば解決。
              </li>
              <li>
                静的ファイルの警告:
                <code>STATICFILES_DIRS</code> を確認し、<code>static/</code>
                ディレクトリを作成。
              </li>
            </ul>

            <h2 id="refs">参考資料</h2>
            <ul>
              <li>
                <a href="https://docs.djangoproject.com/"
                  >Django 公式ドキュメント</a
                >
              </li>
              <li>
                <a href="https://www.django-rest-framework.org/"
                  >Django REST framework</a
                >
              </li>
              <li><a href="https://docs.celeryq.dev/">Celery 公式</a></li>
            </ul>

            <div class="footer">
              <p>
                このドキュメントは初学者がプロジェクトを読み、素早く動かせることを目的にしています。必要であれば追加で『API
                開発ガイド』や『テストガイド』等の分割したドキュメントも作成します。
              </p>
            </div>
          </article>
        </main>
      </div>
    </div>
  </body>
</html>
